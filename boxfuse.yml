- name: create aws instance connect
  hosts: localhost
  tasks:
    - name: create key pair
      ec2_key: name=aws_instans region=eu-central-1
      register: instans_key
    - name: Save private key
      copy: content="{{instans_key.key.private_key}}" dest=".ssh/id_rsa" mode=0400
      when: instans_key.changed
    - name: create security group
      ec2_group:
        name: SSH-Allow
        description: SSH allow sg
        vpc_id: vpc-0d08f3b64c0ef84ec
        region: eu-central-1
        rules:
          - proto: tcp
          - ports: 22
          - cidr_ip: 0.0.0.0/0
          - rule_desc: allow SSH
- name: create aws instance
  hosts: localhost
  tasks:
    - name: create instanse
      ec2:
        key_name: aws_instans
        instance_type: t2.micro
        image: ami-05f7491af5eef733a
        wait: yes
        group: aws-instans
        count: 1
        vpc_subnet_id: vpc-0d08f3b64c0ef84ec
        assign_public_ip: yes
      register: created
    - name: update inventory
      add_host:
        name: "{{created.instances[0].public_ip}}"
        groups: aws-instans

- name: build boxfuse
  hosts: aws-instans
  become: yes
  tasks:
    - name: Ensure package is present
      apt: name={{item}} state=present
      with_items:
        - git
        - default-jdk
        - maven
    - name: create directory
      file: path=/home/boxfuse state=directory
    - name: clone repository
      git: repo=https://github.com/boxfuse/boxfuse-sample-java-war-hello.git dest=/home/boxfuse
    - name: build package
      shell: mvn package
      args:
        chdir: /home/boxfuse
    - name: PUT build to bucket
      aws_s3:
        bucket: mybacket1.dmitry-test.com
        object: hello-1.0.war
        src: /home/boxfuse/target/hello-1.0.war
        mode: put
